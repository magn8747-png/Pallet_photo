<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Supplier Photo Uploader</title>
  <style>
    :root {
      --bg: #0b1020;
      --card: #131a32;
      --muted: #8ea0c0;
      --text: #e8eeff;
      --accent: #6aa9ff;
      --ok: #3ddc97;
      --err: #ff6b6b;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    html, body {height: 100%;}
    body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif; background: radial-gradient(1200px 800px at 10% 0%, #0e1530, #080c1a) fixed; color: var(--text); display: grid; place-items: start center; }
    .container { width: min(800px, 92vw); padding: 28px 0 60px; }
    header { display: flex; align-items: center; justify-content: space-between; gap: 16px; margin: 24px 0; }
    h1 { font-size: clamp(1.4rem, 2.5vw, 1.9rem); margin: 0; letter-spacing: .2px; }
    .card { background: linear-gradient(180deg, #1a2242, #101831); border-radius: var(--radius); box-shadow: var(--shadow); padding: 20px; border: 1px solid rgba(255,255,255,.06); }
    label { display: block; font-weight: 600; color: var(--muted); margin-bottom: 8px; }
    select, input[type="text"], button { width: 100%; border-radius: 12px; padding: 12px 14px; border: 1px solid rgba(255,255,255,.08); background: #0f152b; color: var(--text); box-shadow: inset 0 0 0 1px rgba(255,255,255,.03); }
    select:focus, input[type="text"]:focus, button:focus { outline: 2px solid var(--accent); outline-offset: 2px; }
    .row { display: grid; gap: 12px; grid-template-columns: 1fr; }
    @media (min-width: 600px) { .row.two { grid-template-columns: 1fr 1fr; } }
    .hint { color: var(--muted); font-size: .9rem; }
    .muted { color: var(--muted); }
    .pill { display:inline-flex; align-items:center; gap:8px; border-radius:999px; padding:8px 12px; background:#0e1430; border:1px solid rgba(255,255,255,.08); font-size:.9rem }
    .progress { width: 100%; height: 10px; background: #0c1230; border-radius: 999px; overflow: hidden; border: 1px solid rgba(255,255,255,.08); }
    .bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), #7fc6ff); transition: width .15s ease; }
    .actions { display: flex; gap: 10px; }
    .btn { cursor: pointer; font-weight: 700; letter-spacing: .2px; }
    .btn.primary { background: linear-gradient(180deg, #7fb4ff, #4b86ff); color: #0b1020; border: none; }
    .btn.ghost { background: #0f152b; }
    video, canvas, img.preview { width: 100%; border-radius: 14px; background: #020618; border: 1px solid rgba(255,255,255,.06); aspect-ratio: 4/3; object-fit: cover; }
    footer { margin-top: 24px; color: var(--muted); font-size: .9rem; text-align: center; }
    .meta { display:flex; gap:8px; flex-wrap:wrap; font-size:.85rem; color:#a9bee6 }
    .tag { display:inline-block; padding:4px 8px; border-radius:8px; background:#10204a; border:1px solid rgba(255,255,255,.08); color:#a9bee6; font-size:.8rem }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Supplier Photo Uploader</h1>
      <span class="pill">Public link • English UI</span>
    </header>

    <!-- SINGLE COLUMN: Capture / Upload -->
    <section class="card" aria-labelledby="capture-title">
      <h2 id="capture-title" style="margin-top:0">1) Choose supplier & add a photo</h2>

      <div class="row two">
        <div>
          <label for="supplier">Supplier</label>
          <select id="supplier"></select>
          <p class="hint">Pick from the list or type a new name below.</p>
        </div>
        <div>
          <label for="newSupplier">Add new supplier (optional)</label>
          <input id="newSupplier" type="text" placeholder="Type a new supplier name" />
        </div>
      </div>

      <div class="row two" style="margin-top: 8px">
        <button class="btn ghost" id="startCamera">Use camera</button>
        <label class="btn ghost" for="fileInput" style="display:inline-flex; align-items:center; justify-content:center; cursor:pointer">Upload from device</label>
        <input id="fileInput" type="file" accept="image/*" capture="environment" style="display:none" />
      </div>

      <div id="cameraArea" style="margin-top:12px; display:none">
        <video id="video" playsinline></video>
        <div class="actions" style="margin-top:10px">
          <button class="btn" id="stopCamera">Stop</button>
          <button class="btn primary" id="takePhoto">Take photo</button>
        </div>
        <canvas id="canvas" style="display:none"></canvas>
      </div>

      <div id="previewArea" style="margin-top:12px; display:none">
        <img id="previewImg" class="preview" alt="Preview" />
        <div class="meta" id="imgMeta"></div>
        <div class="actions" style="margin-top:10px">
          <button class="btn ghost" id="clearPreview">Clear</button>
          <button class="btn primary" id="uploadBtn">Upload</button>
        </div>
      </div>

      <div id="status" style="margin-top:12px; display:none">
        <div class="progress"><div class="bar" id="progressBar"></div></div>
        <p class="hint" id="statusText" style="margin:.5rem 0 0"></p>
      </div>

      <div id="doneMsg" class="hint" style="display:none; margin-top:10px">Upload complete.</div>
    </section>

    <footer>
      <p>Uploads go to your cloud storage. Configure credentials below.</p>
      <p class="muted">Client‑side downscaling reduces file size before upload. For server‑side control, set an incoming transformation in your upload preset.</p>
    </footer>
  </div>

  <script>
    /***********************
     * CONFIGURATION
     * 1) Create a free Cloudinary account
     * 2) Create an <unsigned> upload preset (Settings → Upload → Upload presets)
     *    - Signing mode: Unsigned
     *    - Allowed formats: images only
     *    - (Optional) Folder: supplier-uploads
     *    - (Optional) Incoming transformation (e.g. w_1600,q_auto,f_auto)
     * 3) Fill in CLOUD_NAME and UPLOAD_PRESET below
     ***********************/

    const CLOUD_NAME = "do4hcjpuj"; // e.g. "demo"
    const UPLOAD_PRESET = "supplier-uploads"; // e.g. "unsigned_images"
    const BASE_URL = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`;

    // Client-side resize config
    const MAX_DIMENSION = 1600; // max width or height
    const JPEG_QUALITY = 0.82; // 0..1

    // Sample suppliers – edit freely
    const DEFAULT_SUPPLIERS = ["AX Food","Coop","Hørkram","Nemlig.com","Rema","Aarstiderne - Engros","Aarstiderne - Privat"];

    const els = {
      supplier: document.getElementById('supplier'), newSupplier: document.getElementById('newSupplier'), startCamera: document.getElementById('startCamera'), stopCamera: document.getElementById('stopCamera'), takePhoto: document.getElementById('takePhoto'), fileInput: document.getElementById('fileInput'), cameraArea: document.getElementById('cameraArea'), video: document.getElementById('video'), canvas: document.getElementById('canvas'), previewArea: document.getElementById('previewArea'), previewImg: document.getElementById('previewImg'), imgMeta: document.getElementById('imgMeta'), clearPreview: document.getElementById('clearPreview'), uploadBtn: document.getElementById('uploadBtn'), status: document.getElementById('status'), progressBar: document.getElementById('progressBar'), statusText: document.getElementById('statusText'), doneMsg: document.getElementById('doneMsg') };

    let stream = null; // camera stream
    let currentBlob = null; // image ready to upload (already downscaled)

    function slugify(s) {
      return s.toString().trim().toLowerCase()
        .normalize('NFD').replace(/[̀-ͯ]/g,'') // remove accents
        .replace(/[^a-z0-9]+/g,'-')
        .replace(/(^-|-$)/g,'');
    } // image ready to upload (already downscaled)

    function initSuppliers() {
      const saved = JSON.parse(localStorage.getItem('suppliers') || '[]');
      const suppliers = [...new Set([...DEFAULT_SUPPLIERS, ...saved])].sort((a,b)=>a.localeCompare(b));
      els.supplier.innerHTML = suppliers.map(s => `<option value="${s}">${s}</option>`).join('');
    }

    els.newSupplier.addEventListener('change', () => {
      const name = els.newSupplier.value.trim(); if (!name) return;
      const saved = JSON.parse(localStorage.getItem('suppliers') || '[]');
      if (!saved.includes(name)) { saved.push(name); localStorage.setItem('suppliers', JSON.stringify(saved)); }
      initSuppliers(); els.supplier.value = name; els.newSupplier.value = '';
    });

    // Camera
    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        els.video.srcObject = stream; await els.video.play(); els.cameraArea.style.display = '';
      } catch (err) { alert('Could not access camera. You can still upload from device.'); console.error(err); }
    }
    function stopCamera() { if (stream) { stream.getTracks().forEach(t => t.stop()); } stream = null; els.cameraArea.style.display = 'none'; }
    function takePhoto() {
      if (!stream) return; const w = els.video.videoWidth || 1280; const h = els.video.videoHeight || 960;
      els.canvas.width = w; els.canvas.height = h; const ctx = els.canvas.getContext('2d'); ctx.drawImage(els.video, 0, 0, w, h);
      els.canvas.toBlob(async blob => { const resized = await downscale(blob); showPreview(resized); }, 'image/jpeg', 0.9);
    }

    // File upload
    els.fileInput.addEventListener('change', async () => {
      const file = els.fileInput.files[0]; if (!file) return; const resized = await downscale(file); showPreview(resized);
    });

    // Downscale using canvas
    async function downscale(blob) {
      const img = await createImageBitmap(blob).catch(async () => {
        // Fallback for browsers that can't decode the format
        return new Promise((resolve, reject) => { const i = new Image(); i.onload = () => resolve(i); i.onerror = reject; i.src = URL.createObjectURL(blob); });
      });
      const iw = img.width, ih = img.height; const scale = Math.min(1, MAX_DIMENSION / Math.max(iw, ih));
      const tw = Math.round(iw * scale), th = Math.round(ih * scale);
      const c = document.createElement('canvas'); c.width = tw; c.height = th; const cx = c.getContext('2d');
      cx.drawImage(img, 0, 0, tw, th);
      const type = 'image/jpeg';
      return await new Promise(resolve => c.toBlob(b => resolve(b), type, JPEG_QUALITY));
    }

    function showPreview(blob) {
      currentBlob = blob; const url = URL.createObjectURL(blob); els.previewImg.src = url; els.previewArea.style.display = '';
      els.status.style.display = 'none'; els.doneMsg.style.display = 'none';
      // meta
      const kb = Math.round(blob.size / 1024); els.imgMeta.innerHTML = `<span class="tag">~${kb} KB</span>`;
    }

    els.clearPreview.addEventListener('click', () => { currentBlob = null; els.previewImg.removeAttribute('src'); els.previewArea.style.display = 'none'; });

    // Upload logic
    els.uploadBtn.addEventListener('click', async () => {
      if (!currentBlob) return alert('Please take or choose a photo first.');
      if (CLOUD_NAME === 'YOUR_CLOUD_NAME' || !UPLOAD_PRESET || UPLOAD_PRESET.includes('YOUR_')) { return alert('Please configure CLOUD_NAME and UPLOAD_PRESET in the code first.'); }
      const supplier = els.supplier.value || 'Unknown';
      const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
      const publicId = `${supplier.replace(/\s+/g,'_')}-${timestamp}`;

      const formData = new FormData();
      // Build filename from supplier + timestamp (no public_id in unsigned mode)
      // Danish local time (Europe/Copenhagen), safe for filenames
      const now = new Date();
      const ts = now
        .toLocaleString('sv-SE', { timeZone: 'Europe/Copenhagen' }) // YYYY-MM-DD HH:MM:SS
        .replace(' ', '_')
        .replace(/[:]/g, '-');
      const supplierSlug = slugify(supplier || 'unknown');
      const filename = `${supplierSlug}-${ts}.jpg`;
      formData.append('file', currentBlob, filename);
      formData.append('upload_preset', UPLOAD_PRESET);
      // NOTE: Filename will be used as public_id when your preset has: Use filename = ON, Unique filename = OFF.

      els.status.style.display = ''; els.progressBar.style.width = '0%'; els.statusText.textContent = 'Uploading…';

      try {
        const xhr = new XMLHttpRequest(); xhr.open('POST', BASE_URL);
        xhr.upload.addEventListener('progress', (e) => { if (e.lengthComputable) { const pct = Math.round((e.loaded / e.total) * 100); els.progressBar.style.width = pct + '%'; els.statusText.textContent = `Uploading… ${pct}%`; } });
        xhr.onreadystatechange = () => {
          if (xhr.readyState === 4) {
            if (xhr.status >= 200 && xhr.status < 300) { els.statusText.textContent = 'Done!'; els.progressBar.style.width = '100%'; els.previewArea.style.display = 'none'; currentBlob = null; els.doneMsg.style.display = ''; }
            else {
              console.error('Upload failed', xhr.status, xhr.responseText);
              els.statusText.textContent = 'Upload failed.';
              els.progressBar.style.width = '0%';
              try { const err = JSON.parse(xhr.responseText); alert('Upload failed: ' + (err.error && err.error.message ? err.error.message : xhr.responseText)); } catch(_) { alert('Upload failed: ' + xhr.responseText); }
            }
          }
        };
        xhr.send(formData);
      } catch (err) { console.error(err); els.statusText.textContent = 'Upload error.'; alert('Upload error. See console for details.'); }
    });

    // wire up
    document.getElementById('startCamera').addEventListener('click', startCamera);
    document.getElementById('stopCamera').addEventListener('click', stopCamera);
    document.getElementById('takePhoto').addEventListener('click', takePhoto);

    // init
    initSuppliers();
  </script>
</body>
</html>

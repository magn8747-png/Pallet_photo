<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Supplier Photo Uploader (Camera Only)</title>
  <style>
    :root {
      --bg: #0b1020;
      --card: #131a32;
      --muted: #8ea0c0;
      --text: #e8eeff;
      --accent: #6aa9ff;
      --ok: #3ddc97;
      --err: #ff6b6b;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    html, body { height: 100%; }
    html { -webkit-text-size-adjust: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
      background: radial-gradient(1200px 800px at 10% 0%, #0e1530, #080c1a) fixed;
      color: var(--text);
      min-height: 100vh;
      min-height: 100dvh;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      display: grid; place-items: start stretch;
    }
    .container { width: min(680px, 94vw); margin: 0 auto; padding: 16px 0 32px; }
    header { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin: 8px 0 12px; }
    h1 { font-size: clamp(1.25rem, 5vw, 1.6rem); margin: 0; letter-spacing: .2px; }
    .card { background: linear-gradient(180deg, #1a2242, #101831); border-radius: var(--radius); box-shadow: var(--shadow); padding: 16px; border: 1px solid rgba(255,255,255,.06); }
    label { display: block; font-weight: 600; color: var(--muted); margin-bottom: 8px; font-size: 0.95rem; }

    select, input[type="text"], button {
      width: 100%;
      border-radius: 14px;
      padding: 14px 16px;
      border: 1px solid rgba(255,255,255,.08);
      background: #0f152b;
      color: var(--text);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
      font-size: 17px;
      line-height: 1.2;
      min-height: 52px;
    }
    select:focus, input[type="text"]:focus, button:focus { outline: 2px solid var(--accent); outline-offset: 2px; }
    button { cursor: pointer; font-weight: 700; letter-spacing: .2px; touch-action: manipulation; }
    .btn.primary { background: linear-gradient(180deg, #7fb4ff, #4b86ff); color: #0b1020; border: none; }
    .btn.ghost { background: #0f152b; border: 1px solid rgba(255,255,255,.08); }
    .row { display: grid; gap: 12px; grid-template-columns: 1fr; }
    @media (min-width: 720px) { .row.two { grid-template-columns: 1fr 1fr; } }
    .hint { color: var(--muted); font-size: .95rem; }
    .muted { color: var(--muted); }
    .progress { width: 100%; height: 12px; background: #0c1230; border-radius: 999px; overflow: hidden; border: 1px solid rgba(255,255,255,.08); }
    .bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), #7fc6ff); transition: width .15s ease; }
    .actions { display: flex; gap: 10px; }
    .actions.stack { flex-direction: column; }
    video, canvas, img.preview {
      width: 100%; border-radius: 16px; background: #020618;
      border: 1px solid rgba(255,255,255,.06); aspect-ratio: 4/3; object-fit: cover;
    }
    footer { margin-top: 20px; color: var(--muted); font-size: .95rem; text-align: center; }
    .meta { display:flex; gap:8px; flex-wrap:wrap; font-size:.9rem; color:#a9bee6 }
    .tag { display:inline-block; padding:4px 8px; border-radius:8px; background:#10204a; border:1px solid rgba(255,255,255,.08); color:#a9bee6; font-size:.8rem }
    .btn.full { width: 100%; }
    .warn { background:#2a1b1b; border:1px solid #5a2a2a; color:#ffd2d2; padding:10px 12px; border-radius:12px; margin-top:8px; display:none; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Supplier Photo Uploader</h1>
      <span class="hint">Camera-only version</span>
    </header>

    <section class="card" aria-labelledby="capture-title">
      <h2 id="capture-title" style="margin-top:0; font-size:1.15rem">Choose supplier & take a photo</h2>

      <div class="row">
        <div>
          <label for="supplier">Supplier</label>
          <select id="supplier">
            <option value="" disabled selected>Select a supplier</option>
          </select>
          <p class="hint">Pick from the list.</p>
        </div>
        <div>
          <label for="newSupplier">Add new supplier (optional)</label>
          <input id="newSupplier" type="text" placeholder="Type a new supplier name" />
        </div>
      </div>

      <div class="row" style="margin-top: 8px">
        <button class="btn primary full" id="startCamera">Use camera</button>
        <div id="httpsWarn" class="warn">Camera requires HTTPS or localhost. Please host this page on a secure URL.</div>
      </div>

      <div id="cameraArea" style="margin-top:12px; display:none">
        <!-- playsinline/autoplay/muted help iOS show the stream after a user gesture -->
        <video id="video" playsinline muted autoplay></video>
        <div class="actions" style="margin-top:10px">
          <button class="btn" id="stopCamera">Stop</button>
          <button class="btn ghost" id="takePhoto">Take photo</button>
        </div>
        <canvas id="canvas" style="display:none"></canvas>
      </div>

      <div id="previewArea" style="margin-top:12px; display:none">
        <img id="previewImg" class="preview" alt="Preview" />
        <div class="meta" id="imgMeta"></div>
        <div class="actions stack" style="margin-top:10px">
          <button class="btn ghost full" id="clearPreview">Clear</button>
          <button class="btn primary full" id="uploadBtn">Upload</button>
        </div>
      </div>

      <div id="status" style="margin-top:12px; display:none">
        <div class="progress"><div class="bar" id="progressBar"></div></div>
        <p class="hint" id="statusText" style="margin:.5rem 0 0"></p>
      </div>

      <div id="doneMsg" class="hint" style="display:none; margin-top:10px">Upload complete.</div>
    </section>

    <footer>
      <p class="muted">Tip: On iOS/Android, camera only works over HTTPS (Netlify/Vercel/GitHub Pages).</p>
    </footer>
  </div>

  <script>
    const CLOUD_NAME = "do4hcjpuj";
    const UPLOAD_PRESET = "supplier-uploads";
    const BASE_URL = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`;
    const MAX_DIMENSION = 1600;
    const JPEG_QUALITY = 0.82;

    const DEFAULT_SUPPLIERS = [
      "Axe Food",
      "Coop",
      "Hørkram",
      "Nemlig.com",
      "Rema",
      "Aarstiderne - Engros",
      "Aarstiderne - Privat"
    ];

    const els = {
      supplier: document.getElementById('supplier'),
      newSupplier: document.getElementById('newSupplier'),
      startCamera: document.getElementById('startCamera'),
      stopCamera: document.getElementById('stopCamera'),
      takePhoto: document.getElementById('takePhoto'),
      cameraArea: document.getElementById('cameraArea'),
      video: document.getElementById('video'),
      canvas: document.getElementById('canvas'),
      previewArea: document.getElementById('previewArea'),
      previewImg: document.getElementById('previewImg'),
      imgMeta: document.getElementById('imgMeta'),
      clearPreview: document.getElementById('clearPreview'),
      uploadBtn: document.getElementById('uploadBtn'),
      status: document.getElementById('status'),
      progressBar: document.getElementById('progressBar'),
      statusText: document.getElementById('statusText'),
      doneMsg: document.getElementById('doneMsg'),
      httpsWarn: document.getElementById('httpsWarn')
    };

    let stream = null;
    let currentBlob = null;

    function slugify(s) {
      return s.toString().trim().toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/[^a-z0-9]+/g,'-')
        .replace(/(^-|-$)/g,'');
    }

    function initSuppliers() {
      const saved = JSON.parse(localStorage.getItem('suppliers') || '[]').filter(Boolean);
      const suppliers = [...new Set([...DEFAULT_SUPPLIERS, ...saved])].sort((a,b)=>a.localeCompare(b));
      let options = '<option value="" disabled selected>Select a supplier</option>';
      options += suppliers.map(s => `<option value="${s}">${s}</option>`).join('');
      els.supplier.innerHTML = options;
    }

    async function startCamera() {
      // Camera requires secure context
      if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        els.httpsWarn.style.display = '';
      } else {
        els.httpsWarn.style.display = 'none';
      }

      // Stop any previous stream (helps on iOS)
      if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }

      // Try exact environment first, then fall back to ideal
      const tryConstraints = async (constraints) => {
        return await navigator.mediaDevices.getUserMedia(constraints);
      };

      const attempts = [
        { video: { facingMode: { exact: 'environment' }, width: { ideal: 1920 }, height: { ideal: 1080 } } },
        { video: { facingMode: { ideal: 'environment' }, width: { ideal: 1920 }, height: { ideal: 1080 } } },
        { video: true }
      ];

      for (const c of attempts) {
        try {
          stream = await tryConstraints(c);
          break;
        } catch (e) {
          console.warn('getUserMedia failed for constraints', c, e);
        }
      }

      if (!stream) {
        alert('Could not access camera. Please check permissions and that you are on HTTPS.');
        return;
      }

      els.video.srcObject = stream;
      try { await els.video.play(); } catch (e) { console.warn('video.play() rejected', e); }
      els.cameraArea.style.display = '';
      els.cameraArea.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function stopCamera() {
      if (stream) { stream.getTracks().forEach(t => t.stop()); }
      stream = null;
      els.cameraArea.style.display = 'none';
    }

    function takePhoto() {
      if (!stream) return;
      const w = els.video.videoWidth || 1280; const h = els.video.videoHeight || 960;
      els.canvas.width = w; els.canvas.height = h;
      const ctx = els.canvas.getContext('2d'); ctx.drawImage(els.video, 0, 0, w, h);
      els.canvas.toBlob(async blob => { const resized = await downscale(blob); showPreview(resized); }, 'image/jpeg', 0.9);
    }

    async function downscale(blob) {
      const img = await createImageBitmap(blob).catch(async () => {
        return new Promise((resolve, reject) => { const i = new Image(); i.onload = () => resolve(i); i.onerror = reject; i.src = URL.createObjectURL(blob); });
      });
      const iw = img.width, ih = img.height; const scale = Math.min(1, MAX_DIMENSION / Math.max(iw, ih));
      const tw = Math.round(iw * scale), th = Math.round(ih * scale);
      const c = document.createElement('canvas'); c.width = tw; c.height = th; const cx = c.getContext('2d');
      cx.drawImage(img, 0, 0, tw, th);
      const type = 'image/jpeg';
      return await new Promise(resolve => c.toBlob(b => resolve(b), type, JPEG_QUALITY));
    }

    function showPreview(blob) {
      currentBlob = blob;
      const url = URL.createObjectURL(blob);
      els.previewImg.src = url;
      els.previewArea.style.display = '';
      els.status.style.display = 'none';
      els.doneMsg.style.display = 'none';
      const kb = Math.round(blob.size / 1024);
      const supplier = els.supplier.value || 'unknown';
      const ts = new Date().toLocaleString('sv-SE', { timeZone: 'Europe/Copenhagen' }).replace(' ', '_').replace(/[:]/g, '-');
      const supplierSlug = slugify(supplier);
      const filename = `${supplierSlug}-${ts}.jpg`;
      els.imgMeta.innerHTML = `<span class="tag">~${kb} KB</span> <span class="tag">${filename}</span>`;
      document.getElementById('uploadBtn').scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    els.clearPreview.addEventListener('click', () => {
      currentBlob = null; els.previewImg.removeAttribute('src'); els.previewArea.style.display = 'none';
    });

    els.uploadBtn.addEventListener('click', async () => {
      if (!currentBlob) return alert('Please take a photo first.');
      if (!els.supplier.value) return alert('Please select or add a supplier first.');
      const supplier = els.supplier.value;
      const ts = new Date().toLocaleString('sv-SE', { timeZone: 'Europe/Copenhagen' }).replace(' ', '_').replace(/[:]/g, '-');
      const supplierSlug = slugify(supplier || 'unknown');
      const filename = `${supplierSlug}-${ts}.jpg`;

      const formData = new FormData();
      formData.append('file', currentBlob, filename);
      formData.append('upload_preset', UPLOAD_PRESET);

      els.status.style.display = '';
      els.progressBar.style.width = '0%';
      els.statusText.textContent = 'Uploading…';

      try {
        const xhr = new XMLHttpRequest(); xhr.open('POST', BASE_URL);
        xhr.upload.addEventListener('progress', (e) => {
          if (e.lengthComputable) {
            const pct = Math.round((e.loaded / e.total) * 100);
            els.progressBar.style.width = pct + '%';
            els.statusText.textContent = `Uploading… ${pct}%`;
          }
        });
        xhr.onreadystatechange = () => {
          if (xhr.readyState === 4) {
            if (xhr.status >= 200 && xhr.status < 300) {
              els.statusText.textContent = 'Done!';
              els.progressBar.style.width = '100%';
              els.previewArea.style.display = 'none';
              currentBlob = null;
              els.doneMsg.style.display = '';
              window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
              console.error('Upload failed', xhr.status, xhr.responseText);
              els.statusText.textContent = 'Upload failed.';
              els.progressBar.style.width = '0%';
              try {
                const err = JSON.parse(xhr.responseText);
                alert('Upload failed: ' + (err.error && err.error.message ? err.error.message : xhr.responseText));
              } catch(_) {
                alert('Upload failed: ' + xhr.responseText);
              }
            }
          }
        };
        xhr.send(formData);
      } catch (err) {
        console.error(err);
        els.statusText.textContent = 'Upload error.';
        alert('Upload error. See console for details.');
      }
    });

    // Wire up
    document.getElementById('startCamera').addEventListener('click', startCamera);
    document.getElementById('stopCamera').addEventListener('click', stopCamera);
    document.getElementById('takePhoto').addEventListener('click', takePhoto);

    // Init
    document.addEventListener('DOMContentLoaded', initSuppliers);
    if (document.readyState !== 'loading') initSuppliers();
  </script>
</body>
</html>
